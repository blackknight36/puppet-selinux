#
# Bacula Director Configuration
#
# Origin: modules/dart/templates/bacula/bacula-dir.conf
#

# Director console that provides console access with full capabilities.
Director {
    Name = <%= scope.lookupvar('dart::params::bacula_dir_name') %>
    DIRport = 9101
    QueryFile = "/etc/bacula/query.sql"
    WorkingDirectory = "/var/spool/bacula"
    PidDirectory = "/var/run"
    Maximum Concurrent Jobs = 1
    Password = "<%= scope.lookupvar('dart::params::bacula_dir_passwd') %>"
    Messages = Daemon
}


# Restricted console used by tray-monitor to get the status of the director.
Console {
    Name = <%= scope.lookupvar('dart::params::bacula_mon_name') %>
    Password = "<%= scope.lookupvar('dart::params::bacula_mon_passwd') %>"
    CommandACL = status, .status
}

@/etc/bacula/director/schedules.conf
@/etc/bacula/director/jobs.conf
@/etc/bacula/director/clients.conf
@/etc/bacula/director/file-sets.conf

Storage {
    Name = File
    Address = <%= scope.lookupvar('dart::params::bacula_sd_fqdn') %>
    SDPort = 9103
    Password = "<%= scope.lookupvar('dart::params::bacula_sd_passwd') %>"
    Device = FileStorage
    Media Type = File
}

Catalog {
    Name = MyCatalog
    dbname = "bacula"; dbuser = "bacula"; dbpassword = "dd247026629bf00bd64bdeaff45e89bd"
}

# Send most everything to email address and to the console.
Messages {
    Name = Standard
#
# NOTE! If you send to two email or more email addresses, you will need
#  to replace the %r in the from field (-f part) with a single valid
#  email address in both the mailcommand and the operatorcommand.
#  What this does is, it sets the email address that emails would display
#  in the FROM field, which is by default the same email as they're being
#  sent to.  However, if you send email to more than one address, then
#  you'll have to set the FROM address manually, to a single address.
#  for example, a 'no-reply@mydomain.com', is better since that tends to
#  tell (most) people that its coming from an automated source.

    # NB: Note that when % follows <, you must double the % due to puppet's
    #     ERB templating.
    #
    mailcommand = "/usr/sbin/bsmtp -h smtp.dartcontainer.com -f \"mdct_bacula_director@dart.biz\" -s \"Bacula: %l %t %e on %c\" %r"
    operatorcommand = "/usr/sbin/bsmtp -h localhost -f \"mdct_bacula_director@dart.biz\" -s \"Bacula: Intervention needed for %j\" %r"
    # TODO
    # mail = nathan.nephew@dart.biz,ben.minshall@dart.biz,john.florian@dart.biz,chris.pugh@dart.biz,levi.harper@dart.biz,kristina.doyle@dart.biz,elizabeth.scott@dart.biz = all, !skipped
    mail = john.florian@dart.biz = all, !skipped
    # operator = nathan.nephew@dart.biz,ben.minshall@dart.biz,john.florian@dart.biz,chris.pugh@dart.biz,levi.harper@dart.biz = mount
    operator = john.florian@dart.biz = mount
    console = all, !skipped, !saved
#
# WARNING! the following will create a file that you must cycle from
#          time to time as it will grow indefinitely. However, it will
#          also keep all your messages if they scroll off the console.
#
    append = "/var/log/bacula/bacula.log" = all, !skipped
    catalog = all
}

# Message delivery for daemon messages (no job).
Messages {
    Name = Daemon
    # NB: Note that when % follows <, you must double the % due to puppet's
    #     ERB templating.
    mailcommand = "/usr/sbin/bsmtp -h smtp.dartcontainer.com -f \"mdct_bacula_director@dart.biz\" -s \"Bacula: %l %t %e on %c\" %r"
    # TODO
    # mail = nathan.nephew@dart.biz,ben.minshall@dart.biz,john.florian@dart.biz,chris.pugh@dart.biz,levi.harper@dart.biz,kristina.doyle@dart.biz,elizabeth.scott@dart.biz = all, !skipped
    mail = john.florian@dart.biz = all, !skipped
    console = all, !skipped, !saved
    append = "/var/log/bacula/bacula.log" = all, !skipped
}

Pool {
    Name = File
    Pool Type = Backup
    Recycle = yes               # Bacula can automatically recycle Volumes
    AutoPrune = yes             # Prune expired volumes
    # Volumes must be retained at least twice the interval for full backups!
    #
    # WARNING: If the Volume Retention period is to be changed, you should
    # first review the documentation.  Bacula will honor the value stored in
    # each volume and in the Catalog Database Media record in favor over the
    # value given here.  Thus if a change is desired, you will almost
    # certainly also need to update the existing volumes and the Catalog
    # Database Media record.
    Volume Retention = 30 days  # Just over four weeks
    Maximum Volume Bytes = 5G   # Limit Volume size to something reasonable
    Maximum Volumes = 2000      # Limit number of Volumes in Pool
    Label Format = backupVolume
    Volume Use Duration = 30d;
    Recycle Oldest Volume = yes
}
